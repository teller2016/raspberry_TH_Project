<!DOCTYPE html>
{% load static %}

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>우정바이오 온습도계</title>
    
    <link href="{% static '/css/web.css' %}" media="(min-width:601px)" rel="stylesheet" type="text/css">
    <link href="{% static '/css/mobile.css' %}" media="(max-width:600px)" rel="stylesheet" type="text/css">
    
    <link media="all" href="{% static 'js/nv.d3.css' %}" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="{% static 'js/d3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/nv.d3.min.js' %}"></script>
    <script src="{% static 'js/stream_layers.js' %}"></script>
    <script type="text/javascript">
        String.prototype.replaceAll = function(org, dest) {
            return this.split(org).join(dest);
        }
        function csv_name(){
            var userInput = prompt("저장을 원하는 csv파일의 이름을 입력해주세요.\n(이름은 영어와 숫자로만 구성되어야 합니다.)")
            if(userInput == null){
                alert("취소되었습니다.");
            } else{
                alert("다운로드를 시작합니다.");
                location.href="/th_csv/"+userInput;
            }
        }
    </script>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

    <style>
        text {
            font: 12px sans-serif;
        }
        svg {
            display: block;
        }
        #chart, svg {
            margin: 0px;
            padding: 0px;
            height: 450px;
            width: 98%;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="logo"><a href="{% url 'home' %}"><img class="logo-img" src="{% static '/images/KS.jpg' %}"></a></div>
    <div class="main-title-container">
	    <h1 class="main-title">우정바이오 무선 온습도계</h1>
    </div>
</div>
<a href="{% url 'home' %}"><button class="btn-back"> < </button></a>

<div class="result">
    <a href="{% url 'result' %}"><button class="btn-re">새로고침</button></a>
    <p class="graph-title">측정 결과 확인</p>
</div>

<div class="table-div result">
<button class="button2" onclick="csv_name();">엑셀 파일 저장</button>
<p class="home-title bt2">측정 결과</p>

	<table class="table-result" id="table_data"> </table>
        
	<br><br>
</div>
<br><br>

<script type="text/javascript">
        function getHMS(HMS){

            var gmt = new Date(HMS); //err ( GMT + 9 + 9 is current value)
            var date = new Date(gmt.getTime() + (gmt.getTimezoneOffset() * 60000)); //-9 hours ( GMT + 9 )
            
            let hours = ('0' + date.getHours()).slice(-2);
            let minutes = ('0' + date.getMinutes()).slice(-2);
            let seconds = ('0' + date.getSeconds()).slice(-2);
            
            let time = hours+':'+minutes+':'+seconds;
            
            return time;
        }
        
        function getThData(){
                
                $.ajax({
                            url: "/getAllThData/",
                            type: 'POST',
                            headers:{
                                'X-CSRFToken': '{{csrf_token}}'
                                },
                            success:function(data){
                                
                                $('#cur_value').empty();
                                
                                $('#cur_value').append(
                                    "<td class='ver-line'>" + data[0].fields.run_id + "</td>" +
                                    "<td class='ver-line'>" + data[0].fields.run_time_str + "</td>" +
                                    "<td class='ver-line'>" + data[0].fields.humidity + "</td>" +
                                    "<td class='ver-line'>" + data[0].fields.temperature + "</td>" +
                                    "<td class='ver-line'>" + getHMS(data[0].fields.run_time_date)+ "</td>" 
                                )
                                
                                
                                //while($('#table_data').length >1){
                                 //   $('#table_data').deleteRow(1);
                                 //   }
                                 $('#table_data').empty();
                                    
                                //console.log($('#state_id').html());
                                let state_run_id = $('#state_id').html();
                                let table_head_html =
                                    "<tr class='tr-bar2'>" +
                                    "<th><font>no.</font></th>" +
                                    "<th><font>경과 시간</font></th>" +
                                    "<th><font>습도(%)</font></th>" +
                                    "<th><font>온도(°C)</font></th>" +
                                    "<th><font>측정 시간</font></th>" +
                                    "</tr>"
                                $('#table_data').append( table_head_html )
                                
                                $.each(data, function(key, value){
                                
                                    let run_id = value.fields.run_id;
                                    let run_time_str = value.fields.run_time_str;
                                    let humidity = value.fields.humidity;
                                    let temperature = value.fields.temperature;
                                    let run_time_date = value.fields.run_time_date;
                                    
                                    let tr_html = '';
                                    
                                    if( run_id == state_run_id)
                                        tr_html = "<tr class='peak'>";
                                    else
                                        tr_html = "<tr>";
                                   
                                        
                                    $('#table_data').append( tr_html +
                                        "<td><font>" + run_id + "</font></td>" +
                                        "<td><font>" + run_time_str + "</font></td>" +
                                        "<td><font>" + humidity + "</font></td>" +
                                        "<td><font>" + temperature + "</font></td>" +
                                        "<td><font>" + getHMS(run_time_date) + "</font></td>" +
                                        "</tr>"
                                    );
                                
                                });
                                
                                
                                
                                
                            },
                            error: function(){
                                console.log('Ajax getThData Error!!');
                            }
                        });
            
            }

    
        

        function refreshData(){
                
                getThData();
            }
        
        
        refreshData();
        if( {{run_state}} == 1)
            setInterval(refreshData, 2000); // refresh every x seconds
        

    </script>

</body>
</html>

