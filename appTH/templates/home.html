<!DOCTYPE html>
{% load static %}
<html lang="en">
  
<head>
    <meta charset="utf-8">
    
    <!--    브라우저 너비를 장치 너비에 맞추어 표시함-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>우정바이오 온습도계</title>
    <link href="{% static '/css/web.css' %}" media="(min-width:600px)" rel="stylesheet" type="text/css">
    <link href="{% static '/css/mobile.css' %}" media="(max-width:600px)" rel="stylesheet" type="text/css">
    
    <link media="all" href="{% static 'js/nv.d3.css' %}" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="{% static 'js/d3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/nv.d3.min.js' %}"></script>
    <script src="{% static 'js/stream_layers.js' %}"></script>

    <link rel="stylesheet" type="text/css" href="{% static 'datetimepicker/jquery.datetimepicker.css' %}" />
    <script src="{% static 'datetimepicker/jquery.js' %}"></script>
    <script src="{% static 'datetimepicker/build/jquery.datetimepicker.full.min.js' %}"></script>
    
    <link rel="stylesheet" href="{% static 'wickedpicker/stylesheets/wickedpicker.css' %}">
    <script src="{% static 'wickedpicker/src/wickedpicker.js' %}"></script>
    
    <!-- javascript on static file -->
    <script src="{% static 'js/functions.js' %}"></script>
    <!-- home.html ajax functions -->
    <script src="{% static 'js/home_ajax.js' %}"></script>
    
    <script type="text/javascript">
    
    
        String.prototype.replaceAll = function(org, dest) {
            return this.split(org).join(dest);
        }

    </script>
    
    <style>
        text {
            font: 12px sans-serif;
        }
        svg {
            display: block;
        }
        #chart, svg {
            margin: 0 auto;
            padding: 0px;
            height: 300px;
            max-width: 700px;
            width: 100%;
        }
    </style>
</head>
<body>
	
		{% include 'header.html' %}
	
	<div class="content-container">
	    <div class="pi-select">
		<p class="home-title">온습도계 선택</p>
		<a href="http://192.168.243.1:8000/summary"><button>전체 확인</button></a>
		<a href="http://192.168.243.1:8000/" class='connection-box connection1'><button class='connection-status btn-me'>1번</button></a>
		<a href="http://192.168.243.2:8000/" class='connection-box connection2'><button class='connection-status'>2번</button></a>
		<a href="http://192.168.243.3:8000/" class='connection-box connection3'><button class='connection-status'>3번</button></a>
	    </div>
        <br>
	
	<!-- 현재시간 -->
        <div class='pi-list'>
            <div class='content-summary2'>
                <div class='time-box'>현재시간</div>
                <span class="time-title2" id="cur_date" >date</span>
                <span class="time-title2" id="cur_time" >time</span>
            </div>
        </div>
	
	<!-- PI 기준 (시간 + 주기)--><!-- 경과시간 -->
        <div>
            <p class="time-title2" style="font-size:15px">PI No.1 기준</p>
            
            <div class='pi-list'>
                <div class='content-summary2'>
                    <div class='time-box'>시작시간</div>
                    <span class='time-title2'>{{th_state.start_time|date:"Y-m-d H:i:s"}}</span>
                </div>
                
                {% if run_state == 2 %}
                <div class='content-summary2'>
                    <div class='time-box'>종료시간</div>
                    <span class='time-title2'>{{th_state.end_time|date:"Y-m-d H:i:s"}}</span>
                </div>
                {% else %}
                <div class='content-summary2'>
                    <div class='time-box'>경과시간</div>
                    <span class='time-title2' id='run_time'>run_time</span>
                </div>
                {% endif %}
            
            </div>
            
            <p class="time-title2" id="dataCycle">측정주기: N/A</p>
        </div>
	
	
        <div class="content-summary">
	    
        <a href="{% url 'result' %}"><button class="button2">현재 데이터 조회</button></a>
        <a href="{% url 'beforeResult' %}"><button class="button2">과거 데이터 조회</button></a>
	
	<p class="home-title bt1">측정 상태 요약</p>

	<table class="table-th">
            <br/>
            <tr>
                <th class='thick'></th>
                <th class='ver-line thick' style='border:3px solid' colspan=2>최대값 데이터</th>
                <th rowspan=5 class='thick2'></th>
                <th class='ver-line' style='border:3px solid' colspan=2>실시간 데이터</th>
                <th rowspan=5 class='thick2' style='border-right:0px'></th>
            </tr>
            
            <tr class="tr-bar">
                <th class="ver-line thick"><font>PI NO.</font></th>
                
                <th class="ver-line"><font>최대 습도(%)</font></th>
                <th class="ver-line thick"><font>경과 시간</font></th>
                
                <th class="ver-line"><font>현재 습도(%)</font></th>
                <th class="ver-line thick"><font>온도(°C)</font></th>
                
                
            </tr>
            <!-- PI Data -->
            <tr id="summary1">
                <td class='ver-line thick'>{{pi_num}}</td>
                
                <td class='ver-line' id='maxHumidity'>-</td>
                <td class='ver-line' id='maxRunTime'>-</td>
                
                <td class='ver-line' id='curHumidity'>-</td>
                <td class='ver-line' id='curTemperature'>-</td>
                
                <td style='display:none' id='curRunId'>-</td>
                
            </tr>
            

            
        </table>


        
        <br>
        </div>
        <br>
        
		<div class="pi-state">
		
		
        {% if run_state == 1 %}
        <p>온습도계 실행 상태: <strong style="color:#FF4765">실행중</strong> </p>
        </div>
        
        <br>
        <hr class="hr-div">
        <br>
	
	<div class='content-summary2'>
	    <button class="btn-end" onclick="end_check();">개별 종료</button>
            <button class="btn-endAll" onclick="end_all();">전체 종료</button>
        </div>
        
        {% else %}
        <p>온습도계 실행 상태: <strong style="color:blue">대기중</strong> </p>
        </div>
        <br>
        <hr class="hr-div">
        <br>
        
	<div class='content-summary2'>
            <table class='table-start'>
        
            <tr>
                <td>
                    측정 주기
                </td>
            </tr>
            <tr>
                <td>
                 <input type="range" id="cycle" name="cycle" value="30" min="5" step="5" max="60"  onInput="setCycle()">
                <label for="cycle" id="cycleLabel">30초</label>
                </td>
                
            </tr>
            </table>
            
            <button class="btn-start" onclick="start_check();">개별 측정<br>시작</button>
        </div>
        
        
        {% endif %}
        

        <script type="text/javascript">
        let currentDate = document.getElementById("cur_date");
        let currentTime = document.getElementById("cur_time");
        
	clock('{{th_state.start_time|date:"Y/m/d H:i:s"}}', {{run_state}});
        setInterval(()=>clock('{{th_state.start_time|date:"Y/m/d H:i:s"}}', {{run_state}}),1000);
        
        
            
        </script>
        
        
    <div class="graph-div">
    <br><br>
    <a href="{% url 'graph' %}"><button class="button2">더보기</button></a>
    <p class="home-title bt2">측정 결과 그래프</p>
    
    
    <div id="chart" class='with-3d-shadow with-transitions'>
        <svg></svg>
    </div>

    <script type="text/javascript">
        

        var chart = nv.models.lineChart();
        
        nv.addGraph(function() {
        
	
	var dataList = new Array();
	var dataList2 = new Array();
	
	var th_data = [
	  {
	    "key": "습도(%)",
	    "color": "#00ace6",
	    "values": dataList
	  },
	  {
	    "key": "온도(°C)",
	    "color": "#FF4765",
	    "values": dataList2
	  }
	]
	
	
        chart.xAxis.tickFormat((time)=>xAxisLabel(time)).axisLabel("시간(분, 초)");
        
        chart.yDomain([0,100]);
        chart.yTickFormat(d3.format(',.1f'));

        chart.useInteractiveGuideline(true);
        

        d3.select('#chart svg')
            .datum(th_data)
            .call(chart);

        nv.utils.windowResize(chart.update);

        return chart;
    });   

        
        function refreshData(){
                getThState();
                getThData();
                getAllThData();
                
            }
        
	checkRunning();
        setInterval(checkRunning, 5000);
	
        refreshData();
        if( {{run_state}} == 1)
            setInterval(refreshData, 2000); // refresh every x seconds


    </script>
    <br><br><br><br>
	</div>
    <div class="table-div">
	<button class="button2" onclick="csv_name({{pi_num}}, '{{th_state.start_time|date:'Ymd_His'}}')">엑셀 파일 저장</button>
    <p class="home-title bt2">측정 결과 미리보기</p>
        <table class="table-result" id="table_data">
            
        
        
        </table>
        <br><br>
    </div>
    <br><br>
</body>
