<!DOCTYPE html>
{% load static %}
<html lang="en">
  
<head>
    <meta charset="utf-8">
    {% if run_state == 1 %}
    <meta http-equiv="refresh" content="10;url=">
    {% endif %}
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>우정바이오 온습도계</title>
    <link href="{% static '/css/main.css' %}" rel="stylesheet" type="text/css">
    
    <link media="all" href="{% static 'js/nv.d3.css' %}" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="{% static 'js/d3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/nv.d3.min.js' %}"></script>
    <script src="{% static 'js/stream_layers.js' %}"></script>

    <link rel="stylesheet" type="text/css" href="{% static 'datetimepicker/jquery.datetimepicker.css' %}" />
    <script src="{% static 'datetimepicker/jquery.js' %}"></script>
    <script src="{% static 'datetimepicker/build/jquery.datetimepicker.full.min.js' %}"></script>
    
    <link rel="stylesheet" href="{% static 'wickedpicker/stylesheets/wickedpicker.css' %}">
    <script src="{% static 'wickedpicker/src/wickedpicker.js' %}"></script>    

    <script type="text/javascript">
        String.prototype.replaceAll = function(org, dest) {
            return this.split(org).join(dest);
        }
        function csv_name(){
            var userInput = prompt("저장을 원하는 csv파일의 이름을 입력해주세요. (이름은 영어와 숫자로 구성되어야 합니다.)")
            if(userInput == null){
                alert("취소되었습니다.");
            } else{
                alert("다운로드를 시작합니다.");
                location.href="/th_csv/"+userInput;
            }
        }
        function start_check(){
            var result = confirm("정말로 시작하시겠습니까? 시작시 이전의 데이터는 모두 삭제됩니다.");
            if(result){
                var userInput_date = document.getElementById("datetimepicker").value;
                var userInput_time = document.getElementById("timepicker").value;
                if(userInput_date == ""){
                    alert("현재 날짜를 입력해주세요.");
                    document.getElementById("datetimepicker").focus();
                } else {
                    var userInput = userInput_date + " " + userInput_time.replaceAll(" ","")+":00";
                    location.href="/restart/"+userInput;
                    return true;
                }
            }
             return false;
        }
    </script>
    <style>
        text {
            font: 12px sans-serif;
        }
        svg {
            display: block;
        }
        #chart, svg {
            margin: 0px;
            padding: 0px;
            height: 300px;
            max-width: 450px;
            width: 100%;
        }
    </style>
</head>
<body>
    <a href="{% url 'home' %}"><img class="logo" src="{% static '/images/KS.jpg' %}"></a>
    
    <h1 class="title1">감염관리사업부 온습도계</h1>
    <div class="pi-select">
        <h4>파이 선택</h4>
        <a href="http://192.168.243.13:8000/"><button class="btn-pi-me">13번</button></a>
        <a href="http://192.168.243.13:8000/"><button class="btn-pi">26번</button></a>
        <a href="http://192.168.243.13:8000/"><button class="btn-pi">27번</button></a>
    </div>
    <div class="result">
        <p class="title2">측정 상태 요약</p>
        <div class="pi-state">
        <p>시작시간: {{th_state.start_time|date:"Y/m/d H:i:s"}}</p>
        {% if run_state == 2 %}
        <p>종료시간: {{th_state.end_time|date:"Y/m/d H:i:s"}}</p>
        {% endif %}
        <p>최대 습도:</p>
        <table class="table-th">
            <tr class="tr-bar">
                <th><font size = 3>no.</font></th>
                <th><font size = 3>경과 시간</font></th>
                <th><font size =3>습도(%)</font></th>
                <th><font size=3>온도(°C)</font></th>
                <th><font size = 3>현재 시간</font></th>
            </tr>
            <tr>
                <th>{{th_state.run_id}}</th>
                <th>{{th_state.run_time_str}}</th>
                <th>{{th_state.max_hum}}</th>
                <th>{{th_state.max_hum_temp}}</th>
                <th>{{th_state.max_hum_time|date:"H:i:s"}}</th>
            </tr>
        </table>
        {% if run_state == 1 %}
        <p>파이 실행 상태: <strong style="color:red">실행중</strong> </p>
        </div>
        <br>
        <a href="{% url 'end' %}"><button class="btn-end">종료하기</button></a>
        {% else %}
        <p>파이 실행 상태: <strong style="color:blue">대기중</strong> </p>
        </div>
        <div class="div-start">
        <br>
        <table class="table-start">
           <tr>
              <td>날짜</td>
              <td>
                <input id="datetimepicker" type="text" value="" placeholder="YYYY-MM-DD" class="start-input">
                <script type="text/javascript">
                    jQuery('#datetimepicker').datetimepicker({
                      lang:'ko',
                      format:'Y-m-d',
                      timepicker:false,
                     });
                </script>
              </td>
              <td rowspan="2"><button class="btn-start" onclick="start_check();">시작하기</button></td>
           </tr>
           <tr>
              <td>시간</td>
              <td>
                <input id="timepicker" type="text" name="timepicker" class="start-input"/>
                <script>
                    var options = {
                        twentyFour: true,
                        secondsInterval: 1,};
                    jQuery('#timepicker').wickedpicker(options);
                </script>
              </td>
           </tr>
        </table>

        <button class="btn-csv" onclick="csv_name();">csv파일로 저장하기</button>
        {% endif %}
        <br>
        </div>
    </div>
    <div class="result2">
        <p class="title2">측정 결과 그래프  <a href="{% url 'graph' %}"><img class="graph-img" src="{% static '/images/graph.JPG' %}"></a></p>
    
    </div>
    <div id="chart" class='with-3d-shadow with-transitions'>
        <svg></svg>
    </div>

    <script type="text/javascript">

        nv.addGraph(function() {
        var chart = nv.models.lineChart();
    
        var dataList = new Array();
        var dataList2 = new Array();
        
        {% for th in th_list %}
            var data = new Object() ;
            data.x = {{th.run_time}}
            data.y = {{th.humidity}}
            data.series = 0
            dataList.push(data);
            
            var data2 = new Object() ;
            data2.x = {{th.run_time}}
            data2.y = {{th.temperature}}
            data2.series = 1
            dataList2.push(data2);
        {% endfor %}
    
        var th_data = [
          {
            "key": "습도(%)",
            "color": "#00ace6",
            "values": dataList
          },
          {
            "key": "온도(°C)",
            "color": "#ff5c33",
            "values": dataList2
          }
        ]
    
    
        chart.xAxis.tickFormat(d3.format(',f')).axisLabel("시간(초)");
        chart.x2Axis.tickFormat(d3.format(',f'));

        chart.yDomain([0,100]);
        chart.yTickFormat(d3.format(',.1f'));

        chart.useInteractiveGuideline(true);

        d3.select('#chart svg')
            .datum(th_data)
            .call(chart);

        nv.utils.windowResize(chart.update);

        return chart;
        });

    </script>
    <br>
    <div class="result">
        <p class="title2">측정 결과 확인</p>
    </div>
    <div class="table-div">
        <table class="table-th2">
            <tr class="tr-bar">
                <th><font size = 3>no.</font></th>
                <th><font size = 3>경과 시간</font></th>
                <th><font size =3>습도(%)</font></th>
                <th><font size=3>온도(°C)</font></th>
                <th><font size = 3>현재 시간</font></th>
            </tr>
        {% for th in th_list %}
            <tr>
                <th><font size = 3>{{th.run_id}}</font></th>
                <th><font size = 3>{{th.run_time_str}}</font></th>
                <th><font size = 3>{{th.humidity}}</font></th>
                <th><font size=3>{{th.temperature}}</font></th>
                <th><font size = 3>{{th.run_time_date|date:"H:i:s"}}</font></th>
            </tr>
        {% endfor %}
        </table>
    </div>
</body>
