<!DOCTYPE html>
{% load static %}
<html lang="en">
  
<head>
    <meta charset="utf-8">
    {% if run_state == 1 %}
    <meta http-equiv="refresh" content="30;url=">
    {% endif %}
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>우정바이오 온습도계</title>
    <link href="{% static '/css/web.css' %}" media="(min-width:600px)" rel="stylesheet" type="text/css">
    <link href="{% static '/css/mobile.css' %}" media="(max-width:600px)" rel="stylesheet" type="text/css">
    
    <link media="all" href="{% static 'js/nv.d3.css' %}" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="{% static 'js/d3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/nv.d3.min.js' %}"></script>
    <script src="{% static 'js/stream_layers.js' %}"></script>

    <link rel="stylesheet" type="text/css" href="{% static 'datetimepicker/jquery.datetimepicker.css' %}" />
    <script src="{% static 'datetimepicker/jquery.js' %}"></script>
    <script src="{% static 'datetimepicker/build/jquery.datetimepicker.full.min.js' %}"></script>
    
    <link rel="stylesheet" href="{% static 'wickedpicker/stylesheets/wickedpicker.css' %}">
    <script src="{% static 'wickedpicker/src/wickedpicker.js' %}"></script>
    
    <script type="text/javascript">
        String.prototype.replaceAll = function(org, dest) {
            return this.split(org).join(dest);
        }
        function csv_name(){
            var userInput = prompt("저장을 원하는 csv파일의 이름을 입력해주세요.\n(이름은 영어와 숫자로만 구성되어야 합니다.)")
            if(userInput == null){
                alert("취소되었습니다.");
            } else{
                alert("다운로드를 시작합니다.");
                location.href="/th_csv/"+userInput;
            }
        }
        function start_check(){
            var result = confirm("정말로 시작하시겠습니까? 시작시 이전의 데이터는 모두 삭제됩니다.");
            if(result){
                var userInput_date = document.getElementById("datetimepicker").value;
                var userInput_time = document.getElementById("timepicker").value;
                if(userInput_date == ""){
                    alert("현재 날짜를 입력해주세요.");
                    document.getElementById("datetimepicker").focus();
                } else {
                    var userInput = userInput_date + " " + userInput_time.replaceAll(" ","")+":00";
                    location.href="/restart/"+userInput;
                    return true;
                }
            }
             return false;
        }
        function end_check(){
            var result = confirm("정말로 종료하시겠습니까?");
            if(result){
                location.href="/end";
                return true;
            }
             return false;
        }
    </script>
    
    <style>
        text {
            font: 12px sans-serif;
        }
        svg {
            display: block;
        }
        #chart, svg {
            margin: 0 auto;
            padding: 0px;
            height: 300px;
            max-width: 700px;
            width: 100%;
        }
    </style>
</head>
<body>
	<div class="header">
		<div class="logo"><a href="{% url 'home' %}"><img class="logo-img" src="{% static '/images/KS.jpg' %}"></a></div>
		<div class="main-title-container">
			<h1 class="main-title">우정바이오 무선 온습도계</h1>
		</div>
	</div>
	<div class="content-container">
		<div class="pi-select">
        <p class="home-title">온습도계 선택</p>
		<a href="http://192.168.243.13:8000/"><button class="btn-me">13번</button></a>
		<a href="http://192.168.243.26:8000/"><button>26번</button></a>
		<a href="http://192.168.243.27:8000/"><button>27번</button></a>
		</div>
        <br>
        <div class="content-summary">
        <a href="{% url 'result' %}"><button class="button2">전체 데이터 보기</button></a>
		<p class="home-title bt1">측정 상태 요약</p>
        <p class="time-title">시작시간: {{th_state.start_time|date:"Y/m/d H:i:s"}}</p>
        {% if run_state == 2 %}
        <p class="time-title">종료시간: {{th_state.end_time|date:"Y/m/d H:i:s"}}</p>
        {% endif %}

        <table class="table-th">
            <tr class="tr-bar">
                <th class="ver-line"><font>NO.</font></th>
                <th class="ver-line"><font>경과 시간</font></th>
                <th class="ver-line"><font>최대 습도(%)</font></th>
                <th class="ver-line"><font>온도(°C)</font></th>
                <th class="ver-line"><font>현재 시간</font></th>
            </tr>
            <tr>
                <td class="ver-line">{{th_state.run_id}}</td>
                <td class="ver-line">{{th_state.run_time_str}}</td>
                <td class="ver-line">{{th_state.max_hum}}</td>
                <td class="ver-line">{{th_state.max_hum_temp}}</td>
                <td class="ver-line">{{th_state.max_hum_time|date:"H:i:s"}}</td>
            </tr>
        </table>
        <br>
        </div>
        <br>
		<div class="pi-state">
        {% if run_state == 1 %}
        <p>온습도계 실행 상태: <strong style="color:#FF4765">실행중</strong> </p>
        </div>
        <br>
        <hr class="hr-div">
        <br>
        <button class="btn-end" onclick="end_check();">종료</button>
        {% else %}
        <p>온습도계 실행 상태: <strong style="color:blue">대기중</strong> </p>
        </div>
        <br>
        <hr class="hr-div">
        <br>
        <table class="table-start">
           <tr>
              <td>날짜</td>
              <td>
                <input id="datetimepicker" type="text" value="" placeholder="YYYY-MM-DD"/>
                <script type="text/javascript">
                    jQuery('#datetimepicker').datetimepicker({
                      lang:'ko',
                      format:'Y-m-d',
                      timepicker:false,
                     });
                </script>
              </td>
              <td rowspan="3"><button class="btn-start" onclick="start_check();">새로<br>시작</button></td>
           </tr>
           <tr><td colspan="2"><hr></td></tr>
           <tr>
              <td>시간</td>
              <td>
                <input id="timepicker" type="text" name="timepicker"/>
                <script>
                    var options = {
                        twentyFour: true,
                        secondsInterval: 1,};
                    jQuery('#timepicker').wickedpicker(options);
                </script>
              </td>
           </tr>
        </table>
        {% endif %}
    <div class="graph-div">
    <br><br>
    <a href="{% url 'graph' %}"><button class="button2">더보기</button></a>
    <p class="home-title bt2">측정 결과 그래프</p>
    
    
    <div id="chart" class='with-3d-shadow with-transitions'>
        <svg></svg>
    </div>

    <script type="text/javascript">

        nv.addGraph(function() {
        var chart = nv.models.lineChart();
    
        var dataList = new Array();
        var dataList2 = new Array();
        
        {% for th in th_list %}
            var data = new Object() ;
            data.x = {{th.run_time}}
            data.y = {{th.humidity}}
            data.series = 0
            dataList.push(data);
            
            var data2 = new Object() ;
            data2.x = {{th.run_time}}
            data2.y = {{th.temperature}}
            data2.series = 1
            dataList2.push(data2);
        {% endfor %}
    
        var th_data = [
          {
            "key": "습도(%)",
            "color": "#00ace6",
            "values": dataList
          },
          {
            "key": "온도(°C)",
            "color": "#FF4765",
            "values": dataList2
          }
        ]
    
    
        chart.xAxis.tickFormat(d3.format(',f')).axisLabel("시간(초)");
        chart.x2Axis.tickFormat(d3.format(',f'));

        chart.yDomain([0,100]);
        chart.yTickFormat(d3.format(',.1f'));

        chart.useInteractiveGuideline(true);

        d3.select('#chart svg')
            .datum(th_data)
            .call(chart);

        nv.utils.windowResize(chart.update);

        return chart;
        });

    </script>
    <br><br><br><br>
	</div>
    <div class="table-div">
	<button class="button2" onclick="csv_name();">엑셀 파일 저장</button>
    <p class="home-title bt2">측정 결과 미리보기</p>
        <table class="table-result">
            <tr class="tr-bar2">
                <th><font>no.</font></th>
                <th><font>경과 시간</font></th>
                <th><font>습도(%)</font></th>
                <th><font>온도(°C)</font></th>
                <th><font>현재 시간</font></th>
            </tr>
        {% for th in th_list_mini %}
        {% if th.run_id == th_state.run_id %}
            <tr class="peak">
        {% else %}
            <tr>
        {% endif %}
                <td><font>{{th.run_id}}</font></td>
                <td><font>{{th.run_time_str}}</font></td>
                <td><font>{{th.humidity}}</font></td>
                <td><font>{{th.temperature}}</font></td>
                <td><font>{{th.run_time_date|date:"H:i:s"}}</font></td>
            </tr>
        {% endfor %}
        </table>
        <br><br>
    </div>
    <br><br>
</body>
